<header class="header">
  <nav class="navbar">
    <a routerLink="/" class="logo">
      <img src="https://cdn-icons-png.flaticon.com/512/4538/4538836.png" alt="Logo" class="logo-icon">
      <h1>Petites Annonces</h1>
    </a>
    <div class="nav-links">
      <a routerLink="/dashboard" class="nav-link">
        <img src="https://cdn-icons-png.flaticon.com/512/3917/3917776.png" alt="Dashboard" class="nav-icon">
        <span>Tableau de bord</span>
      </a>
      <a routerLink="/" class="nav-link">
        <img src="https://cdn-icons-png.flaticon.com/512/1946/1946488.png" alt="Accueil" class="nav-icon">
        <span>Accueil</span>
      </a>
    </div>
  </nav>
</header>

<div class="page-header">
  <div class="container">
    <div class="page-header-icon">
      <img src="https://cdn-icons-png.flaticon.com/512/1159/1159633.png" alt="Edit">
    </div>
    <h1 class="page-title">Modifier l'annonce</h1>
    <p class="page-subtitle">Mettez √† jour les informations de votre annonce</p>
  </div>
</div>

<div class="container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner-large"></div>
    <p>Chargement de l'annonce...</p>
  </div>

  <!-- Alert -->
  <div *ngIf="showAlert" 
       class="alert" 
       [class.success]="alertType === 'success'"
       [class.error]="alertType === 'error'"
       [class.warning]="alertType === 'warning'"
       [class.info]="alertType === 'info'"
       [class.animate-slide-out]="!showAlert">
    <img *ngIf="alertType === 'success'" 
         src="https://cdn-icons-png.flaticon.com/512/5610/5610944.png" 
         alt="Success" 
         class="alert-icon">
    <img *ngIf="alertType === 'error'" 
         src="https://cdn-icons-png.flaticon.com/512/6659/6659895.png" 
         alt="Error" 
         class="alert-icon">
    <img *ngIf="alertType === 'warning'" 
         src="https://cdn-icons-png.flaticon.com/512/5610/5610944.png" 
         alt="Warning" 
         class="alert-icon">
    <img *ngIf="alertType === 'info'" 
         src="https://cdn-icons-png.flaticon.com/512/471/471662.png" 
         alt="Info" 
         class="alert-icon">
    <span>{{ alertMessage }}</span>
  </div>

  <!-- Changes Indicator -->
  <div *ngIf="!isLoading && hasChanges()" class="changes-indicator">
    <img src="https://cdn-icons-png.flaticon.com/512/471/471662.png" alt="Info" style="width: 20px; height: 20px;">
    <span>Vous avez des modifications non enregistr√©es</span>
  </div>

  <!-- Form Card -->
  <div class="form-card" *ngIf="!isLoading">
    <form [formGroup]="annonceForm" (ngSubmit)="onSubmit()">
      
      <!-- Section 1: Type d'annonce -->
      <div class="form-section">
        <h2 class="section-title">
          <img src="https://cdn-icons-png.flaticon.com/512/2785/2785482.png" alt="Type" class="section-icon">
          <span>Type d'annonce</span>
        </h2>
        <p class="section-subtitle">S√©lectionnez le type d'annonce</p>
        <div class="section-divider"></div>
        
        <div class="type-cards">
          <div class="type-card" 
               *ngFor="let type of typesAnnonce" 
               [class.selected]="annonceForm.get('type')?.value === type.value"
               (click)="selectType(type.value)">
            <div class="type-icon">
              <img [src]="type.icon" [alt]="type.label">
            </div>
            <span>{{ type.label }}</span>
            <small>{{ type.description }}</small>
          </div>
        </div>
        <div class="error-message" *ngIf="isFieldInvalid('type')">
          {{ getErrorMessage('type') }}
        </div>
      </div>

      <!-- Section 2: Informations g√©n√©rales -->
      <div class="form-section">
        <h2 class="section-title">
          <img src="https://cdn-icons-png.flaticon.com/512/2541/2541988.png" alt="Info" class="section-icon">
          <span>Informations g√©n√©rales</span>
        </h2>
        <div class="section-divider"></div>
        
        <div class="form-group" [class.invalid]="isFieldInvalid('titre')">
          <label>
            Titre de l'annonce <span class="required">*</span>
          </label>
          <input 
            type="text" 
            formControlName="titre"
            placeholder="Ex: Appartement 2 pi√®ces √† louer - Centre ville"
            maxlength="100">
          <div class="char-counter"
               [class.near-limit]="titreCount > 80"
               [class.at-limit]="titreCount >= 100">
            {{ titreCount }}/100 caract√®res
          </div>
          <div class="error-message" *ngIf="isFieldInvalid('titre')">
            {{ getErrorMessage('titre') }}
          </div>
        </div>

        <div class="form-group" [class.invalid]="isFieldInvalid('prix')">
          <label>
            <img src="https://cdn-icons-png.flaticon.com/512/2331/2331966.png" alt="Price" class="label-icon">
            Prix (FCFA)
          </label>
          <input 
            type="number" 
            formControlName="prix"
            placeholder="Ex: 50000"
            min="0"
            step="1000">
          <small>Laissez vide si le prix est √† n√©gocier</small>
          <div class="error-message" *ngIf="isFieldInvalid('prix')">
            {{ getErrorMessage('prix') }}
          </div>
        </div>
      </div>

      <!-- Section 3: Description -->
      <div class="form-section">
        <h2 class="section-title">
          <img src="https://cdn-icons-png.flaticon.com/512/2920/2920277.png" alt="Description" class="section-icon">
          <span>Description d√©taill√©e</span>
        </h2>
        <p class="section-subtitle">Soyez pr√©cis et honn√™te dans votre description</p>
        <div class="section-divider"></div>

        <div class="form-group" [class.invalid]="isFieldInvalid('description')">
          <label>
            Description <span class="required">*</span>
          </label>
          <textarea 
            formControlName="description"
            placeholder="D√©crivez votre annonce en d√©tail : caract√©ristiques, √©tat, localisation, avantages, etc."
            maxlength="1000"></textarea>
          <div class="char-counter"
               [class.near-limit]="descriptionCount > 850"
               [class.at-limit]="descriptionCount >= 1000">
            {{ descriptionCount }}/1000 caract√®res
          </div>
          <div class="error-message" *ngIf="isFieldInvalid('description')">
            {{ getErrorMessage('description') }}
          </div>
        </div>
      </div>

      <!-- Section 4: Localisation et Contact -->
      <div class="form-section">
        <h2 class="section-title">
          <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="Location" class="section-icon">
          <span>Localisation et Contact</span>
        </h2>
        <div class="section-divider"></div>

        <div class="form-row">
          <div class="form-group" [class.invalid]="isFieldInvalid('ville')">
            <label>
              <img src="https://cdn-icons-png.flaticon.com/512/2838/2838912.png" alt="City" class="label-icon">
              Ville <span class="required">*</span>
            </label>
            <div class="select-wrapper">
              <select formControlName="ville">
                <option value="">S√©lectionnez une ville</option>
                <option *ngFor="let ville of villes" [value]="ville">
                  {{ ville }}
                </option>
              </select>
            </div>
            <div class="error-message" *ngIf="isFieldInvalid('ville')">
              {{ getErrorMessage('ville') }}
            </div>
          </div>

          <div class="form-group">
            <label>
              <img src="https://cdn-icons-png.flaticon.com/512/854/854901.png" alt="Neighborhood" class="label-icon">
              Quartier
            </label>
            <input 
              type="text" 
              formControlName="quartier"
              placeholder="Ex: Nkwen, Bamendankwe">
            <small>Pr√©cisez le quartier pour plus de visibilit√©</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" [class.invalid]="isFieldInvalid('telephone')">
            <label>
              <img src="https://cdn-icons-png.flaticon.com/512/724/724664.png" alt="Phone" class="label-icon">
              T√©l√©phone <span class="required">*</span>
            </label>
            <input 
              type="tel" 
              formControlName="telephone"
              placeholder="+237 6XX XX XX XX">
            <small>Format: +237 6XX XX XX XX ou +237 2XX XX XX XX</small>
            <div class="error-message" *ngIf="isFieldInvalid('telephone')">
              {{ getErrorMessage('telephone') }}
            </div>
          </div>

          <div class="form-group" [class.invalid]="isFieldInvalid('email')">
            <label>
              <img src="https://cdn-icons-png.flaticon.com/512/732/732200.png" alt="Email" class="label-icon">
              Email (optionnel)
            </label>
            <input 
              type="email" 
              formControlName="email"
              placeholder="votre.email@exemple.com">
            <small>Pour recevoir les demandes par email</small>
            <div class="error-message" *ngIf="isFieldInvalid('email')">
              {{ getErrorMessage('email') }}
            </div>
          </div>
        </div>
      </div>

      <!-- Section 5: Images -->
      <div class="form-section">
        <h2 class="section-title">
          <img src="https://cdn-icons-png.flaticon.com/512/3342/3342137.png" alt="Photos" class="section-icon">
          <span>Photos de l'annonce</span>
        </h2>
        <p class="section-subtitle">
          ‚ú® Modifiez ou ajoutez des photos (au moins 1 photo requise)
        </p>
        <div class="section-divider"></div>

        <div class="image-upload-container" 
             (click)="triggerFileInput()"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onDrop($event)"
             [class.disabled]="uploadedImages.length >= MAX_IMAGES">
          <img src="https://cdn-icons-png.flaticon.com/512/1160/1160358.png" alt="Upload" class="upload-icon">
          <h3 class="upload-title">
            {{ uploadedImages.length >= MAX_IMAGES ? 'Limite d\'images atteinte' : 'Cliquez pour ajouter des photos' }}
          </h3>
          <p class="upload-text" *ngIf="uploadedImages.length < MAX_IMAGES">
            ou glissez-d√©posez vos images ici
          </p>
          <p class="upload-limit">
            Maximum {{ MAX_IMAGES }} images ‚Ä¢ JPG, PNG, WEBP (Max 5 MB chacune)
          </p>
        </div>

        <input 
          type="file" 
          id="imageInput"
          accept="image/jpeg,image/png,image/jpg,image/webp" 
          multiple
          (change)="onFileSelected($event)"
          [disabled]="uploadedImages.length >= MAX_IMAGES"
          style="display: none;">

        <!-- Upload Progress -->
        <div class="upload-progress" *ngIf="isSubmitting && uploadProgress > 0">
          <div class="progress-bar-container">
            <div class="progress-bar" [style.width.%]="uploadProgress"></div>
          </div>
          <p class="progress-text">Mise √† jour en cours... {{ uploadProgress }}%</p>
        </div>

        <div class="image-preview-grid" *ngIf="uploadedImages.length > 0">
          <div class="image-preview-item animate-fade-in" 
               *ngFor="let img of uploadedImages; let i = index"
               [class.existing-image]="img.isExisting">
            <img [src]="img.data" [alt]="img.name">
            <div class="image-overlay">
              <span class="image-name">{{ img.name }}</span>
              <span *ngIf="img.isExisting" class="image-badge">Existante</span>
              <span *ngIf="!img.isExisting" class="image-badge new">Nouvelle</span>
            </div>
            <button type="button" 
                    class="remove-image-btn" 
                    (click)="removeImage(i)"
                    [disabled]="isSubmitting"
                    title="Supprimer cette image">
              <img src="https://cdn-icons-png.flaticon.com/512/1828/1828778.png" alt="Remove">
            </button>
          </div>
        </div>

        <div class="image-count animate-fade-in" *ngIf="uploadedImages.length > 0">
          <img src="https://cdn-icons-png.flaticon.com/512/3342/3342137.png" alt="Images" class="count-icon">
          <span>
            <strong>{{ uploadedImages.length }}</strong>/{{ MAX_IMAGES }} images
            <span *ngIf="uploadedImages.length === MAX_IMAGES" style="color: #10b981;">
              ‚úì Maximum atteint
            </span>
          </span>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="isSubmitting">
          <img src="https://cdn-icons-png.flaticon.com/512/1828/1828778.png" alt="Cancel" class="btn-icon">
          <span>Annuler</span>
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || annonceForm.invalid || uploadedImages.length === 0 || !hasChanges()">
          <img *ngIf="!isSubmitting" src="https://cdn-icons-png.flaticon.com/512/5996/5996747.png" alt="Save" class="btn-icon">
          <div *ngIf="isSubmitting" class="spinner"></div>
          <span>{{ isSubmitting ? 'Enregistrement...' : 'Enregistrer les modifications' }}</span>
        </button>
      </div>

      <!-- Form Summary -->
      <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px; text-align: center; font-size: 0.875rem; color: #6b7280; border: 1px solid #e5e7eb;">
        <strong style="color: #1f2937;">üí° Note:</strong> Les modifications seront visibles imm√©diatement apr√®s l'enregistrement.
      </div>
    </form>
  </div>
</div>